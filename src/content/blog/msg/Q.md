---
title: '生产消费模型中的幂等性'
author: '安'
description: '面试常问：什么是幂等？如何在生产消费模型中保证幂等？直白讲清楚。'
publishDate: '2025-09-02'
updatedDate: '2025-09-02'
tags:
- 消息队列
- 幂等
- 面试
language: 'Chinese'
draft: false
heroImage: { src: './0.jpg', color: '#85E4EA' }
---
## 问题
在生产者—消费者模型中，如何保证幂等？什么是幂等？ 

## 回答
幂等其实就是**同一条消息，处理一次和处理多次，结果必须一样**。为什么要提这个？因为在生产消费模型里，网络抖动、重试、消息重复投递都很常见，如果不控制就会出现数据多扣、状态错乱。

比如说支付扣款，你收到了一条“扣 100”的消息，如果重复消费了两次，用户就被扣了 200，这是不允许的；幂等就要求你设计成**重复扣款只生效一次**。

那怎么保证？可以从两个角度：

1. **生产端**尽量避免重复，比如加唯一 ID，去重发送；
2. **消费端**一定要容错：

    * 常见方法是 **业务主键去重**，比如给消息加一个唯一流水号，消费时先查“这条流水号我处理过没有”，处理过就丢掉。
    * 也可以靠 **幂等操作设计**，比如数据库用 `insert ... on duplicate key update`，保证重复写入不影响最终结果。
    * 或者用 **幂等表 / Redis** 记录消费过的消息 ID。

本质就是：我们知道重复不可避免，所以要让**重复执行 = 执行一次**，这就是幂等。
